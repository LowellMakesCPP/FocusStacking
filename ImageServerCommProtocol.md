# FocusStacking ImageServer communication protocol


Reference: [TCP/IP Protocol Design: Message Framing, by **Stephen Cleary**, 25 Jun 2009](http://www.codeproject.com/Articles/37496/TCP-IP-Protocol-Design-Message-Framing)

1. Messages are encoded in [ASCII](http://en.wikipedia.org/wiki/ASCII), binary data are encoded in hex within a message.
2. Each message unit starts with a STX (Acsii code: 002) character followed by a four character message code (case sensitive), followed by data that depends on the message.
3. Each message ends with a ETX (Ascii code: 003, End of Text).
4. Data can never contain the characters STX or ETX.
5. Message data are at most 10240 bytes (= 10 KB) in length. Longer data transfers need to be split into multiple fragments.
6. The same message id can be used for the query or request and reply from server

Databases and stacks:

7. A server only serves one database at a time.
8. A host may serve multiple databases at the same time by operating multiple servers at different ports.
9. Databases have unique ids (preferably global by using UUIDs), and an identifying name and description. Database names can be up to 256 [32-bit unicode](http://en.wikipedia.org/wiki/UTF-32) characters long. Descriptions can be up to 1024 32-bit unicode characters long. Names and descriptions will be stored and transmitted as 3 digit encoding followed by hex characters. The encoding can be as follows:
   1. **ASC**: 8-bit ascii
   2. **U08**: UTF-8
   3. **U16**: UTF-16
   4. **U32**: UTF-32
10. A database can hold up to 2^32 = 4294967296 stacks.

Each stack holds the following information:

1. A series of source images in JPEG or TIFF format (each image can be a maximum of 1GB) and a stack can hold at most 10,000 images
2. Meta-information about the focal distance of each image if available, or NA if not available
3. Units for distance information (um, mm, cm, m, km, in, ft, mile)
4. X and Y scale information if available
5. Units for X and Y scale information if available
6. Information on creator (name, i.p., date-time)
7. a set of focal maps



In the following definitions, Cl represents a message from client to server, while Se represents a message from server to client. The following messages are defined:

1. **GTID**: get stack id. Sent from client to server to request for a new stack id. There is no data associated with this message. Server returns
newly assigned stack id to client. A stack id is a 128 bit [UUID](http://en.wikipedia.org/wiki/Universally_unique_identifier) generated by the
server that is guaranteed to be unique for a given database. The data consists of 32 lower-case hexadecimal digits. Thus a full message exchange
could look like:
```
Cl "_\002GTID\003_" 
Se "_\002GTID123e4567e89b12d3a456426655440000\003_"
```
The server should create a new folder with the name as defined in the [database format](https://github.com/LowellMakesCPP/FocusStacking/blob/master/DatabaseFormat.md).

2. **PING**: ping server. Client requests server for identification. Server returns version and database information. Example: 
```
Cl"_\002PING\003_" Se
"\002PING FocusStacking ImageServer version 0.1 \n
Database: 123e4567e89b12d3a452426655440000\003"
```
3. **LSTN**: number of stacks currently in database. Client requests server for list of stacks stored in the database. Server returns number in
lowercase hexadecimal. For example, if there are 29 stacks, the communication could look like:
```
Cl"_\002LSTN\003_" Se"_\002LSTN1d\003_"
```
If there aren't any stacks in the database yet, the server should return:
```
Se"_\002LSTN0\003_"
```
where '0' after LSTN is the ASCII character '\060'.

4. **LSTK**:  returns UUIDs n stacks starting at the kth stack in server. Client sends k as a hexadecimal number starting from 0 followed by a comma
and number of stacks to return, again as a hexadecimal number. Server returns empty if there are less than (k-1) stacks currently in server. The
stacks are sorted by UUID for the purpose of indexing. The stack ids are juxtaposed. The maximum number of stack ids a client can request at a
time is 10240/32 = 320.
5. **UUNM**: returns name of stack identified by given UUID. If stack cannot be found in database returns empty. Client send 32 UUID as message data
Server sends 32 UUID followed by 3 characters denoting encoding, followed by name.
6. **UUDS**: returns description of stack.
7. **UULN**: returns number of images in stack.


